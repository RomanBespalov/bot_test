<!DOCTYPE html>
{% load static %}
{% comment %} {% load messages %} {% endcomment %}
<html>
<head>
    <title>Создание Рассылки</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{% static 'admin/css/bootstrap.min.css' %}">
</head>
<body>
    <form id="combinedForm" method="post" enctype="multipart/form-data" action="{% url 'broadcast' %}">
        {% csrf_token %}
        <!-- Add hidden field to store selectedButtons data -->
        <input type="hidden" name="selectedButtons" id="selectedButtons">

        <!-- Render fields from the second form -->
        {% for field in form %}
        {% if field.name != 'buttons' and field.name != 'recipients' %}
                <div class="form-group row my-3 p-3">
                    <label for="{{ field.id_for_label }}">
                        {{ field.label }}
                        {% if field.field.required %}                
                            <span class="required text-danger">*</span>
                        {% endif %}        
                    </label>
                        {{ field }}
                </div>
            {% endif %}
        {% endfor %}
        <div style="margin: 20px 0;">
            <button>
                <a href="#" onclick="showRecipientsPopup()" style="text-decoration: none; color: black;">
                    Выбрать пользователей для рассылки
                </a>
            </button>
        </div>        
        <div id="buttonContainer">
            <div>
                <select data-row="0" name="button_0">
                    <option value="">Выберите кнопку</option>
                    {% for button in buttons %}
                        <option value="{{ button.id }}">{{ button.name }}</option>
                    {% endfor %}
                </select>
                <button class="addButtonInRow" type="button">+</button>
            </div>
        </div>
        <div style="margin-bottom: 20px;">
            <button id="addButton" type="button">+</button>
        </div>
        <div>
            <button type="submit" name="create" value="create" class="btn btn-primary">
                Создать
            </button>
            <button type="submit" name="test_broadcast" value="test_broadcast" class="btn btn-primary">
                Тестовая рассылка
            </button>
            <a href="{% url 'admin:index' %}" class="btn btn-primary" style="color: white;">Перейти в админку</a>
            <button type="submit" name="template" value="template" class="btn btn-primary">
                Создать шаблон рассылки
            </button>
        </div>
    </form>

    <script>
        $(document).ready(function() {
            $(document).on("click", ".addButtonInRow", function() {
                var row = $(this).parent().find("select").data('row');
                var select = $('<select data-row="' + row + '" name="button_' + row + '">');
                select.append('<option value="">Выберите кнопку</option>');
                {% for button in buttons %}
                    select.append('<option value="{{ button.id }}">{{ button.name }}</option>');
                {% endfor %}
                $(this).before(select);
            });

            $("#addButton").click(function() {
                var newRowNum = $("#buttonContainer").find("div").length;
                var newRow = $('<div>');
                newRow.append('<select data-row="' + newRowNum + '" name="button_' + newRowNum + '">' +
                    '<option value="">Выберите кнопку</option>' +
                    '{% for button in buttons %}' +
                    '<option value="{{ button.id }}">{{ button.name }}</option>' +
                    '{% endfor %}' +
                    '</select>');
                newRow.append('<button class="addButtonInRow" type="button">+</button>');
                $("#buttonContainer").append(newRow);
            });

            // Modify the submit function for combinedForm
            $("#combinedForm").submit(function(event) {
                event.preventDefault();

                var selectedButtons = [];
                $("select[name^='button_']").each(function() {
                    var selectedValue = $(this).val();
                    var row = $(this).data('row');
                    if (selectedValue !== "") {
                        selectedButtons.push({ name: $(this).attr('name'), value: selectedValue });
                    }
                });

                // Set the value of the hidden field with the selectedButtons data
                $("#selectedButtons").val(JSON.stringify(selectedButtons));

                // Get the name of the clicked button
                var clickedButtonName = $(document.activeElement).attr("name")
                // Add the clicked button name to the form data
                var formData = new FormData(this);
                formData.append("clickedButton", clickedButtonName);

                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                // Submit the combinedForm
                $.ajax({
                    url: "{% url 'broadcast' %}",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    },
                    success: function(response) {
                        if (clickedButtonName === 'test_broadcast') {
                            alert('Тестовая рассылка успешно отправлена!');
                        } else if (clickedButtonName === 'template') {
                            alert('Шаблон успешно создан!');
                        }
                        else {
                            alert('Рассылка успешно отправлена!');
                            location.reload();
                        }
                    },
                    error: function(xhr, status, error) {
                        // Handle the error
                    }
                });
            });
        });
    </script>
    <script>
        function showRecipientsPopup() {
            window.open('broadcast_users', 'recipients_popup', 'height=500,width=800');
        }
    </script>
</body>
</html>
